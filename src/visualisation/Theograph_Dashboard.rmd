---
title: ""
author: ""
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    toc: false
runtime: shiny
---

<style>
/* Cerulean Theme CSS */

/* Global Styles */
body {
    background-color: #fff; /* White background */
    color: #333; /* Dark text color */
    font-family: Franklin Gothic;
    font-size: 11pt;
    font-weight: 300;
}


h1, h2, h3, h4 {
  color: #407EC9;
}

hr {
  color: #407EC9;
  border-color: #407EC9;
}

/* Navbar Styles */
.navbar {
    background-color: #407EC9; /* Cerulean blue background */
    border-color: #407EC9; /* Cerulean blue border */
    color: #fff; /* White text color */
}

/* Button Styles */
.btn-primary {
    background-color: #407EC9; /* Cerulean blue button background */
    border-color: #407EC9; /* Cerulean blue button border */
    color: #fff; /* White text color */
}

/* Custom button style for pale blue */
.btn-download {
    background-color: #B2D6E0; /* Pale blue background */
    border-color: #B2D6E0; /* Pale blue border */
    color: #fff; /* White text color */
}

/* Links Styles */
a {
    color: #407EC9; /* Cerulean blue link color */
}

/* Add more styles as needed */

.toc.float-toc {
    margin-bottom: 20px; /* Adjust the margin as needed */
}

.plot-container {
    max-width: 900px; /* Control the maximum width of the plot */
    margin-left: auto; /* Align to the right */
    margin-right: 0;
  }
  
  /* Stop nested scrollbars inside Plotly widgets */
.js-plotly-plot .plotly,
.js-plotly-plot .plot-container,
.js-plotly-plot .svg-container {
  overflow: visible !important;
}

  /* Adapting filter message formatting */
  
  .shiny-input-container p em { color: #666; 
}

.plot-outer { overflow: visible !important; 
}

/* Let the page and tab panes expand naturally */
html, body, .container-fluid, .tab-content, .tab-pane {
  height: auto !important;
  min-height: 100vh;
  overflow: visible !important;
}

/* The outer wrapper around the plot should never scroll */
.plot-outer {
  overflow: visible !important;
}

.info-card{
  background:#f7f9fc;
  border:1px solid #e3e8f0;
  padding:12px 14px;
  border-radius:8px;
}
.info-card h4{ margin-top:0; }
.info-multiline{ white-space:pre-wrap; }  /* lets you write multi-line notes without <br> */

  
</style>

```{css, echo=FALSE}
    body .main-container {
      max-width: 1700px !important;
      width: 1700px !important;
    }
    body {
      max-width: 1700px !important;
    }
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

source("../config/r_scripts/packages.R")
source("../data_processing/r_scripts/Data_Extraction_Processing.R")

# Loading the processed data

Pt_Proc_Wide <- read_excel(here("data", "processed_extracts", "Proc_Patient_Extract.xlsx"))

# Creating series to call within the patient selection drop down

patient_names <- unique(Pt_Proc_Wide$Patient_Name)

```

```{r logo, echo = FALSE}

htmltools::img(src = knitr::image_uri(paste0(here(), "/images/DIA_logo_large.png")), 
               alt = 'logo', 
               style = 'position:absolute; top:0; right:5%; padding:10px;',
               width = "180px",
               heigth = "180px")
```

```{r examplePlot, fig.height=18, echo=FALSE}

# Function to create time series plots for biomedical and prescription time series

create_time_series_plot <- function(data, date_col, y_col, test_col, unit_col, vis_colour) {
  tryCatch({
    if (!(date_col %in% names(data)) | !(y_col %in% names(data)) | !(test_col %in% names(data)) | !(unit_col %in% names(data))) {
      stop("One or more specified columns are not found in the data frame.")
    }

    data <- data[!is.na(data[[y_col]]), ]

    data$tooltip_text <- paste0(
      "Date: ", format(data[[date_col]], "%d/%m/%Y"), "<br>",
      data[[test_col]], ": ", data[[y_col]], " ", data[[unit_col]]
    )

    y_label <- paste(test_col, "<br>(", data[[unit_col]][1], ")", sep = "")

    plot <- ggplot(data, aes(x = !!sym(date_col), y = !!sym(y_col))) +
      geom_line(color = vis_colour) +
      geom_point(aes(text = tooltip_text), color = vis_colour, size = 2) +  
      labs(title = NULL, x = "Date", y = y_label) +
      scale_x_date(date_labels = "%d/%m/%Y", limits = c(as.Date("2020-01-01"), as.Date(Sys.Date()))) +
      theme_minimal() +
      theme(axis.title.y = element_text(size = 12))

    plotly_plot <- ggplotly(plot, tooltip = "text") %>% 
      layout(margin = list(l = 250))

    return(plotly_plot)
  }, error = function(e) {
    return(NULL)
  })
}

# Function to create time series plots for diagnoses time series

create_diagnosis_plot <- function(data, date_col, diagnosis_col, vis_colour) {
  tryCatch({
    if (!(date_col %in% names(data)) | !(diagnosis_col %in% names(data))) {
      stop("One or more specified columns are not found in the data frame.")
    }

    data <- data[!is.na(data[[diagnosis_col]]), ]

    data$tooltip_text <- paste0(
      "Date: ", format(data[[date_col]], "%d/%m/%Y"), "<br>",
      "Diagnosis/review: ", data[[diagnosis_col]]
    )

    plot <- ggplot(data, aes(x = !!sym(date_col), y = 1)) + 
      geom_line(color = vis_colour) +
      geom_point(aes(text = tooltip_text), color = vis_colour, size = 2) +  
      labs(title = NULL, x = "Date", y = NULL) +  
      scale_x_date(date_labels = "%d/%m/%Y", limits = c(as.Date("2020-01-01"), as.Date(Sys.Date()))) +
      theme_minimal() +
      theme(
        axis.text.y = element_blank(), 
        axis.ticks.y = element_blank(), 
        axis.title.y = element_blank()
      )

    plotly_plot <- ggplotly(plot, tooltip = "text") %>%
      layout(margin = list(l = 250)) 

    return(plotly_plot)
  }, error = function(e) {
    return(NULL)
  })
}

# UI

ui <- navbarPage(
  title = "Primary Care Timeline Tool",
  id = "main_nav",
  inverse = FALSE,
  header = tags$head(
    tags$style(HTML("
      body {
        width: 100%;
        height: 100%;
        background-color: #fff;
        color: #333;
        font-family: Franklin Gothic, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        font-size: 11pt;
        font-weight: 300;
      }
      h1, h2, h3, h4 { color: #407EC9; }
      hr { color: #407EC9; border-color: #407EC9; }
      .navbar { background-color: #407EC9; border-color: #407EC9; }
      .navbar .navbar-brand, .navbar .navbar-nav > li > a { color: #fff !important; }
      .btn-primary, .btn-download { background-color: #407EC9; border-color: #407EC9; color: #fff; }
      a { color: #407EC9; }
      .toc.float-toc { margin-bottom: 20px; }
      .plot-container { max-width: 1400px; margin-left: auto; margin-right: 0; }
      .shiny-input-container p em { color: #666; }
    "))
  ),

  tabPanel(
  title = "Timeline Tool",
  fluidPage(

    hr(),

    # ROW 1
    fluidRow(
      column(
        width = 3,
        h3("Patient information"),
        hr(),
        uiOutput("patient_report", container = div, class = "info-card")
      ),
      column(
        width = 3,
        h3("Clinical free text"),
        hr(),
        uiOutput("clinical_free_text", container = div, class = "info-card")
      ),

      column(
        width = 3,
        h3("Visualisation filters"),
        hr(),
        p("Pick any mix of diagnoses, biomedical tests, and drugs to show."),
        uiOutput("dx_filter_ui"),
        uiOutput("lab_filter_ui"),
        uiOutput("drug_filter_ui")
      ),
        column(
        width = 3,
        h3("Patient selection"),
        hr(),
        p("This section allows you to search for a patient using given name or surname."),
        selectInput("patient_names", "Select Patient name:", choices = patient_names)
      )
    ),

    # ROW 2 
    fluidRow(
      width = 12,
      h3("Primary Care Timeline Tool"),
      hr(),
      p("The time series below visualises the patient's GP contact history, displaying diagnoses, prescriptions, and assay results."),
      div(class = "plot-outer", uiOutput("combined_plot_ui"))
    ),

    # ROW 3 
    fluidRow(
      column(
        width = 3,
        h3("Contact summary"),
        hr(),
        p("Please use the button below to download the patient's entire GP event history as an Excel workbook file."),
        downloadButton("downloadData", label = "Download patient data", class = "btn-download")
      ),
      column(width = 9)
    )
  )
),

  # User Guidance 
  tabPanel(
    title = "User Guidance",
    fluidPage(
      br(),
      h2("User guidance"),
      hr(),
      p("Space for any appropriate introductory text to be included by University of Liverpool / Data Into Action."),

      br(),
      h2("Categories explored within this tool"),
      hr(),
      p("Following the selection of one of the (fictional) patient's names, the time series below visualises the patient's GP contact history, displaying the following information:"),
      tags$ul(
        tags$li("Date of contact;"),
        tags$li("The initial date of any relevant diagnoses;"),
        tags$li("Any prescriptions (or changes to existing prescriptions) made on date of contact; and"),
        tags$li("The results of any relevant biomedical assays completed on date of contact.")
      )
    )
  )
)


# Server

server <- function(input, output, session) {

# Reactive expression to filter data by selected patient
  
  Pt_Wide_reactive <- reactive({
    req(input$patient_names)
    Pt_Proc_Wide %>%
      filter(Patient_Name == input$patient_names) %>%
      mutate(Contact_Event_Date = as.Date(Contact_Event_Date, format = "%Y-%m-%d")) 
  })
  
  output$clinical_free_text <- renderUI({
  d <- Pt_Wide_reactive()
  nm <- if (nrow(d)) d$Patient_Name[1] else "Selected patient"
  tags$div(
    style = "white-space: pre-wrap; background:#f7f9fc; border:1px solid #e3e8f0; padding:10px; border-radius:8px;",
    paste0(
      "Consultation note (placeholder):\n",
      "- Patient: ", nm, "\n",
      "- Subjective: Reports variable energy levels and occasional dizziness on standing.\n",
      "- Objective: Vitals within acceptable range for age; no acute distress.\n",
      "- Assessment: Stable chronic disease profile; medication adherence discussed.\n",
      "- Plan: Routine bloods at next contact; reinforce lifestyle advice; safety-netting provided."
    )
  )
})

  
# Updating the available Visualisation list based on selected patient
  
# Populating the three multi-selects when a patient is chosen

dx_choices <- reactive({
  d <- Pt_Wide_reactive()
  ch <- sort(unique(c(d$Diagnosis_1, d$Diagnosis_2)))
  ch[!is.na(ch) & ch != ""]
})

lab_choices <- reactive({
  d <- Pt_Wide_reactive()
  ch <- sort(unique(c(d$Biomedical_Test_1, d$Biomedical_Test_2)))
  ch[!is.na(ch) & ch != ""]
})

drug_choices <- reactive({
  d <- Pt_Wide_reactive()
  ch <- sort(unique(c(d$Drug_Name_1, d$Drug_Name_2)))
  ch[!is.na(ch) & ch != ""]
})

# Rendering the three filter UIs

output$dx_filter_ui <- renderUI({
  ch <- dx_choices()
  if (length(ch) == 0) {
    div(class = "form-group shiny-input-container",
        tags$label("Diagnoses", `for` = "dx_filter", class = "control-label"),
        tags$br(),
        tags$em("No diagnoses available for patient.")
    )
  } else {
    checkboxGroupInput("dx_filter", "Diagnoses", choices = ch, inline = FALSE)
  }
})

output$lab_filter_ui <- renderUI({
  ch <- lab_choices()
  if (length(ch) == 0) {
    div(class = "form-group shiny-input-container",
        tags$label("Biomedical tests / assays", `for` = "lab_filter", class = "control-label"),
        tags$br(),
        tags$em("No biomedical tests available for patient.")
    )
  } else {
    checkboxGroupInput("lab_filter", "Biomedical tests / assays", choices = ch, inline = FALSE)
  }
})

output$drug_filter_ui <- renderUI({
  ch <- drug_choices()
  if (length(ch) == 0) {
    div(class = "form-group shiny-input-container",
        tags$label("Drugs", `for` = "drug_filter", class = "control-label"),
        tags$br(),
        tags$em("No prescriptions available for patient.")
    )
  } else {
    checkboxGroupInput("drug_filter", "Drugs", choices = ch, inline = FALSE)
  }
})

combined_height <- reactive({
  d <- Pt_Wide_reactive()
  if (nrow(d) == 0) return(300)

# applying the same OR-filter logic used in renderPlotly
  sel_dx   <- input$dx_filter
  sel_lab  <- input$lab_filter
  sel_drug <- input$drug_filter

  n <- nrow(d)
  dx_keep   <- if (is.null(sel_dx)   || length(sel_dx)   == 0) rep(FALSE, n) else (d$Diagnosis_1 %in% sel_dx | d$Diagnosis_2 %in% sel_dx)
  lab_keep  <- if (is.null(sel_lab)  || length(sel_lab)  == 0) rep(FALSE, n) else (d$Biomedical_Test_1 %in% sel_lab | d$Biomedical_Test_2 %in% sel_lab)
  drug_keep <- if (is.null(sel_drug) || length(sel_drug) == 0) rep(FALSE, n) else (d$Drug_Name_1 %in% sel_drug | d$Drug_Name_2 %in% sel_drug)
  any_selected <- (!is.null(sel_dx) && length(sel_dx) > 0) || (!is.null(sel_lab) && length(sel_lab) > 0) || (!is.null(sel_drug) && length(sel_drug) > 0)
  d <- if (!any_selected) d else d[dx_keep | lab_keep | drug_keep, , drop = FALSE]
  if (nrow(d) == 0) return(300)

# mirroring plot-list/null-filtering to count panels
  plots <- list(
    create_diagnosis_plot(d, "Contact_Event_Date", "Diagnosis_1", "#fa5c5c"),
    create_diagnosis_plot(d, "Contact_Event_Date", "Diagnosis_2", "#36a358"),
    create_time_series_plot(d, "Contact_Event_Date", "Biomedical_Value_1", "Biomedical_Test_1", "Biomedical_1_Units", "#407EC9"),
    create_time_series_plot(d, "Contact_Event_Date", "Biomedical_Value_2", "Biomedical_Test_2", "Biomedical_2_Units", "#407EC9"),
    create_time_series_plot(d, "Contact_Event_Date", "Drug_1_Value", "Drug_Name_1", "Drug_1_Units", "#ff9933"),
    create_time_series_plot(d, "Contact_Event_Date", "Drug_2_Value", "Drug_Name_2", "Drug_2_Units", "#ff9933")
  )
  n_panels <- length(Filter(Negate(is.null), plots))

  per_panel_height <- 180
  base_margin_px   <- 100
  max(200, n_panels * per_panel_height + base_margin_px)
})

output$combined_plot_ui <- renderUI({
  plotlyOutput("combined_plot", height = paste0(combined_height(), "px"), width = "100%")
})

# Rendering the combined plot based on selected visualisation
  
output$combined_plot <- renderPlotly({
  filtered_data <- Pt_Wide_reactive()
  if (nrow(filtered_data) == 0) {
    showNotification("No data available for the selected patient.", type = "warning")
    return(NULL)
  }

  n <- nrow(filtered_data)

  sel_dx   <- input$dx_filter
  sel_lab  <- input$lab_filter
  sel_drug <- input$drug_filter

  dx_keep   <- if (is.null(sel_dx)   || length(sel_dx)   == 0) rep(FALSE, n) else
                 (filtered_data$Diagnosis_1 %in% sel_dx | filtered_data$Diagnosis_2 %in% sel_dx)

  lab_keep  <- if (is.null(sel_lab)  || length(sel_lab)  == 0) rep(FALSE, n) else
                 (filtered_data$Biomedical_Test_1 %in% sel_lab | filtered_data$Biomedical_Test_2 %in% sel_lab)

  drug_keep <- if (is.null(sel_drug) || length(sel_drug) == 0) rep(FALSE, n) else
                 (filtered_data$Drug_Name_1 %in% sel_drug | filtered_data$Drug_Name_2 %in% sel_drug)

  any_selected <- (!is.null(sel_dx)   && length(sel_dx)   > 0) ||
                  (!is.null(sel_lab)  && length(sel_lab)  > 0) ||
                  (!is.null(sel_drug) && length(sel_drug) > 0)

  row_keep <- if (!any_selected) rep(TRUE, n) else (dx_keep | lab_keep | drug_keep)

  filtered_data <- filtered_data[row_keep, , drop = FALSE]
  if (nrow(filtered_data) == 0) {
    showNotification("No data after applying filters.", type = "warning")
    return(NULL)
  }

  create_dynamic_label <- function(data, test_col = NULL, unit_col = NULL, drug_col = NULL, drug_unit_col = NULL, is_test = TRUE) {
    if (is_test) {
      first_non_na_test <- data[[test_col]][!is.na(data[[test_col]])][1]
      first_non_na_unit <- if (!is.null(unit_col) && unit_col != "" && unit_col %in% names(data)) data[[unit_col]][!is.na(data[[unit_col]])][1] else NA
      if (!is.na(first_non_na_test)) {
        if (!is.null(first_non_na_unit) && !is.na(first_non_na_unit)) return(paste(first_non_na_test, "<br>", first_non_na_unit))
        return(first_non_na_test)
      }
    } else {
      first_non_na_drug <- data[[drug_col]][!is.na(data[[drug_col]])][1]
      first_non_na_drug_unit <- data[[drug_unit_col]][!is.na(data[[drug_unit_col]])][1]
      if (!is.na(first_non_na_drug)) {
        if (!is.null(first_non_na_drug_unit) && !is.na(first_non_na_drug_unit)) return(paste(first_non_na_drug, "<br>", first_non_na_drug_unit))
        return(first_non_na_drug)
      }
    }
    return("Unknown Value")
  }

# Creating the time series plots
  
  plot_list <- list(
    create_diagnosis_plot(filtered_data, "Contact_Event_Date", "Diagnosis_1", "#fa5c5c"),
    create_diagnosis_plot(filtered_data, "Contact_Event_Date", "Diagnosis_2", "#36a358"),
    create_time_series_plot(filtered_data, "Contact_Event_Date", "Biomedical_Value_1", "Biomedical_Test_1", "Biomedical_1_Units", "#407EC9"),
    create_time_series_plot(filtered_data, "Contact_Event_Date", "Biomedical_Value_2", "Biomedical_Test_2", "Biomedical_2_Units", "#407EC9"),
    create_time_series_plot(filtered_data, "Contact_Event_Date", "Drug_1_Value", "Drug_Name_1", "Drug_1_Units", "#ff9933"),
    create_time_series_plot(filtered_data, "Contact_Event_Date", "Drug_2_Value", "Drug_Name_2", "Drug_2_Units", "#ff9933")
  )

# Creating the time series labels
  
  label_list <- list(
    create_dynamic_label(filtered_data, test_col = "Diagnosis_1", unit_col = "", is_test = TRUE),
    create_dynamic_label(filtered_data, test_col = "Diagnosis_2", unit_col = "", is_test = TRUE),
    create_dynamic_label(filtered_data, test_col = "Biomedical_Test_1", unit_col = "Biomedical_1_Units", is_test = TRUE),
    create_dynamic_label(filtered_data, test_col = "Biomedical_Test_2", unit_col = "Biomedical_2_Units", is_test = TRUE),
    create_dynamic_label(filtered_data, drug_col = "Drug_Name_1", drug_unit_col = "Drug_1_Units", is_test = FALSE),
    create_dynamic_label(filtered_data, drug_col = "Drug_Name_2", drug_unit_col = "Drug_2_Units", is_test = FALSE)
  )

# Filtering out any null plots
  
  valid_plots  <- Filter(Negate(is.null), plot_list)
  valid_labels <- label_list[!sapply(plot_list, is.null)]

  if (length(valid_plots) == 0) {
    showNotification("No valid plots for the current filters.", type = "warning")
    return(NULL)
  }

# Creating the combined plot output

per_panel_height <- 180
base_margin_px   <- 100 

n_panels <- length(valid_plots)
total_height <- max(200, n_panels * per_panel_height + base_margin_px)

combined_plot <- plotly::subplot(
  valid_plots,
  nrows  = n_panels,
  shareX = TRUE,
  titleX = TRUE
) %>%
  layout(
    annotations = lapply(seq_along(valid_labels), function(i) {
      list(
        x = -0.10,
        y = 1 - (i - 1) * (1 / n_panels) - 0.11,
        text = valid_labels[[i]],
        showarrow = FALSE,
        xref = "paper",
        yref = "paper",
        xanchor = "center",
        yanchor = "middle",
        textangle = 0,
        font = list(size = 14)
      )
    }),
    height = combined_height()
  )


  return(combined_plot)
})


# Creating the patient report output
  
output$patient_report <- renderUI({
  filtered_data <- Pt_Wide_reactive()
  
  if (nrow(filtered_data) == 0) {
    return("No data available for the selected patient.")
  }
  
  patient_name <- trimws(filtered_data$Patient_Name[1])
  patient_gender <- trimws(filtered_data$Patient_Gender[1])
  
  if (!is.null(filtered_data$Patient_DOB[1]) && !is.na(filtered_data$Patient_DOB[1])) {
    patient_dob <- as.Date(filtered_data$Patient_DOB[1], format = "%Y-%m-%d")  
  } else {
    patient_dob <- NA
  }

  if (!is.na(patient_dob)) {
    patient_age <- floor(as.numeric(difftime(Sys.Date(), patient_dob, units = "weeks")) / 52.25)
  } else {
    patient_age <- "Unknown"
  }
  
  diagnoses <- filtered_data %>%
    select(First_Diagnosis, Second_Diagnosis, Contact_Event_Date) %>%
    filter(!is.na(First_Diagnosis) | !is.na(Second_Diagnosis))

  diagnosis_report <- "No formal diagnoses to date."
  if (nrow(diagnoses) > 0) {
    diagnosis_entries <- character()
    
    if (!is.na(diagnoses$First_Diagnosis[1])) {
      first_diagnosis <- trimws(diagnoses$First_Diagnosis[1])
      first_diagnosis_date <- diagnoses$Contact_Event_Date[which(!is.na(diagnoses$First_Diagnosis))[1]]
      diagnosis_entries <- c(diagnosis_entries, paste(first_diagnosis, "on", format(first_diagnosis_date, "%d/%m/%Y")))
    }
    
    if (!is.na(diagnoses$Second_Diagnosis[1])) {
      second_diagnosis <- trimws(diagnoses$Second_Diagnosis[1])
      second_diagnosis_date <- diagnoses$Contact_Event_Date[which(!is.na(diagnoses$Second_Diagnosis))[1]]
      diagnosis_entries <- c(diagnosis_entries, paste(second_diagnosis, "on", format(second_diagnosis_date, "%d/%m/%Y")))
    }
    
    if (length(diagnosis_entries) > 0) {
      diagnosis_report <- paste("Patient diagnosed with", 
                                 paste(diagnosis_entries, collapse = " and "), 
                                 sep = " ")
    }
  }
  
  prescriptions <- filtered_data %>%
    select(First_Drug_Name, Second_Drug_Name, Contact_Event_Date) %>%
    filter(!is.na(First_Drug_Name) | !is.na(Second_Drug_Name))

  prescription_report <- "No prescriptions to date."
  if (nrow(prescriptions) > 0) {
    prescription_entries <- character()
    
    if (!is.na(prescriptions$First_Drug_Name[1])) {
      first_drug <- trimws(prescriptions$First_Drug_Name[1])
      first_drug_date <- prescriptions$Contact_Event_Date[which(!is.na(prescriptions$First_Drug_Name))[1]]
      prescription_entries <- c(prescription_entries, paste(first_drug, "on", format(first_drug_date, "%d/%m/%Y")))
    }
    
    if (!is.na(prescriptions$Second_Drug_Name[1])) {
      second_drug <- trimws(prescriptions$Second_Drug_Name[1])
      second_drug_date <- prescriptions$Contact_Event_Date[which(!is.na(prescriptions$Second_Drug_Name))[1]]
      prescription_entries <- c(prescription_entries, paste(second_drug, "on", format(second_drug_date, "%d/%m/%Y")))
    }
    
    if (length(prescription_entries) > 0) {
      prescription_report <- paste("Patient prescribed", 
                                   paste(prescription_entries, collapse = " and "), 
                                   sep = " ")
    }
  }
  
  if (!endsWith(diagnosis_report, ".")) {
   diagnosis_report <- paste0(diagnosis_report, ".")
  }

  if (!endsWith(prescription_report, ".")) {
   prescription_report <- paste0(prescription_report, ".")
  }


  report <- HTML(paste("<strong>Patient Name:</strong>", patient_name, "<br>",
                       "<strong>Sex:</strong>", patient_gender, "<br>",
                       "<strong>Date of Birth:</strong>", ifelse(!is.na(patient_dob), format(patient_dob, "%d/%m/%Y"), "Unknown"), "<br>",
                       "<strong>Age:</strong>", patient_age, "years", "<br>",
                       "<strong>Diagnosis:</strong>", diagnosis_report, "<br>",
                       "<strong>Prescription(s):</strong>", prescription_report))
  
  report <- trimws(report)
  return(report)
})

# Creating the patient dataset download

output$downloadData <- downloadHandler(
  filename = function() {
    paste("Theograph_Patient_Summary_", Sys.Date(), ".xlsx", sep = "")
  },
  content = function(file) {
    filtered_data <- Pt_Wide_reactive()
    write.xlsx(filtered_data, file)  
  }
)
  
}

shinyApp(ui = ui, server = server, options = list(height = 2200))

```