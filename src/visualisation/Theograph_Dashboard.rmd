---
title: "Primary Care Timeline Tool"
author: "NHS Transformation Unit"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
    toc_collapsed: true
runtime: shiny
---

<style>
/* Cerulean Theme CSS */

/* Global Styles */
body {
    background-color: #fff; /* White background */
    color: #333; /* Dark text color */
    font-family: Franklin Gothic;
    font-size: 11pt;
    font-weight: 300;
}

h1, h2, h3, h4 {
  color: #407EC9;
}

hr {
  color: #407EC9;
  border-color: #407EC9;
}

/* Navbar Styles */
.navbar {
    background-color: #407EC9; /* Cerulean blue background */
    border-color: #407EC9; /* Cerulean blue border */
    color: #fff; /* White text color */
}

/* Button Styles */
.btn-primary {
    background-color: #407EC9; /* Cerulean blue button background */
    border-color: #407EC9; /* Cerulean blue button border */
    color: #fff; /* White text color */
}

/* Links Styles */
a {
    color: #407EC9; /* Cerulean blue link color */
}

/* Add more styles as needed */

.toc.float-toc {
    margin-bottom: 20px; /* Adjust the margin as needed */
}
</style>

```{css, echo=FALSE}
    body .main-container {
      max-width: 1800px !important;
      width: 1800px !important;
    }
    body {
      max-width: 1800px !important;
    }
```


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

library(ggplot2)
library(dplyr)
library(readxl)
library(plotly)
library(kableExtra)
library(shiny)
library(fastmap)
library(lubridate)

source("../config/r_scripts/packages.R")
source("../data_processing/r_scripts/Data_Extraction_Processing.R")

# Load the data
Pt_Proc_Wide <- read_excel("C:/Users/ejroy/OneDrive - Midlands and Lancashire CSU/Git/Primary-Care-Theograph/data/processed_extracts/Proc_Patient_Extract.xlsx")

Pt_Proc_Wide <- Pt_Proc_Wide %>%
  mutate(Contact_Event_Date = dmy(Contact_Event_Date, quiet = TRUE)) %>%
  filter(!is.na(Contact_Event_Date))

# Create a list of unique patient names
patient_names <- unique(Pt_Proc_Wide$Patient_Name)
```

```{r logo, echo = FALSE}

htmltools::img(src = knitr::image_uri(paste0(here(), "/images/DIA_logo_large.png")), 
               alt = 'logo', 
               style = 'position:absolute; top:0; right:5%; padding:10px;',
               width = "180px",
               heigth = "180px")
```

<style>
  .container-fluid {
    display: flex;
  }
  .sidebar {
    width: 25%; /* Adjust the width as needed */
    padding-right: 50px;
  }
  .main {
    width: 75%; /* Adjust the width as needed */
  }
</style>

<div class="container-fluid">
  <div class="sidebar">

## User guidance
***

Introductory text to be agreed with client, but will speak to purpose of tool, including its aims and limitations, as well as some guidance on how the tool is designed to be used.


## Patient selection
***

This section will contain a search bar which will allow the user to search for a patient using either ID# or surname.

```{r dropdownSelection, echo = FALSE}
selectInput("patient_names", "Select Patient ID:", choices = patient_names)
```

</div>

  <div class="main">

## GP Contact, Diagnosis and Prescription Timeline
***

The time series below visualises patient X's GP contact history, displaying the following information:

* Date of contact.
* Any diagnoses made on date of contact.
* Any prescriptions (or changes to existing prescriptions) made on date of contact.
* The results of any relevant biomedical assays completed on date of contact.

```{r examplePlot, echo=FALSE}

library(dplyr)
library(ggplot2)
library(plotly)
library(shiny)

# Function to create time series plots
create_time_series_plot <- function(data, date_col, y_col, test_col, unit_col, vis_colour) {
  tryCatch({
    # Check if required columns exist
    if (!(date_col %in% names(data)) | !(y_col %in% names(data)) | !(test_col %in% names(data)) | !(unit_col %in% names(data))) {
      stop("One or more specified columns are not found in the data frame.")
    }

    # Extract the first non-missing test name and unit
    first_non_na_test <- data[[test_col]][!is.na(data[[test_col]])][1]
    first_non_na_unit <- data[[unit_col]][!is.na(data[[unit_col]])][1]

    # Create tooltip text for Plotly
    data$tooltip_text <- paste0(
      "Date: ", format(data[[date_col]], "%d/%m/%Y"), "\n",
      first_non_na_test, ": ", data[[y_col]], " ", first_non_na_unit
    )

    # Define y-axis label
    y_label <- paste(first_non_na_test, "\n(", first_non_na_unit, ")", sep = "")

    # Plot creation with ggplot2
    plot <- ggplot(data, aes_string(x = date_col, y = y_col)) +
      geom_line(color = vis_colour) +
      geom_point(aes(text = tooltip_text), color = vis_colour, size = 2) +
      labs(title = paste(first_non_na_test, "Over Time"),
           x = "Date",
           y = y_label) +
      scale_x_date(date_labels = "%d/%m/%Y") +
      theme_minimal()

    return(plot)
  }, error = function(e) {
    showNotification(paste("Error creating plot:", e$message), type = "error")  # Display error in UI
    NULL  # Return NULL to handle gracefully in subplot creation
  })
}

# Shiny app UI
ui <- fluidPage(
  sidebarLayout(
    sidebarPanel(selectInput("patient_names", "Select Patient ID:", choices = patient_names)),  # Ensure correct variable name
    mainPanel(
      plotlyOutput('combined_plot')
    )
  )
)

# Shiny app server
server <- function(input, output) {
  
  # Reactive expression to filter the data based on the selected patient
  Pt_Wide_reactive <- reactive({
    req(input$patient_names)  # Ensure a patient is selected
    filtered_data <- Pt_Proc_Wide %>%
      filter(Patient_Name == input$patient_names)  # Use the correct input ID
    filtered_data
  })
  
  # Example of using the filtered data in a plot or table
  output$combined_plot <- renderPlotly({
    filtered_data <- Pt_Wide_reactive()  # Use the reactive filtered data
    
    if (nrow(filtered_data) == 0) {
      return(NULL)  # Return if no data available
    }
    
    plot_1 <- create_time_series_plot(filtered_data, "Contact_Event_Date", "Biomedical_Value_1", "Biomedical_Test_1", "Biomedical_1_Units", "blue")
    plot_2 <- create_time_series_plot(filtered_data, "Contact_Event_Date", "Drug_1_Value", "Drug_Name_1", "Drug_1_Units", "lightblue")
    plot_3 <- create_time_series_plot(filtered_data, "Contact_Event_Date", "Biomedical_Value_2", "Biomedical_Test_2", "Biomedical_2_Units", "orange")
    plot_4 <- create_time_series_plot(filtered_data, "Contact_Event_Date", "Drug_2_Value", "Drug_Name_2", "Drug_2_Units", "yellow")

    # Combine plots into a subplot
    plot_list <- list(plot_1, plot_2, plot_3, plot_4)
    plot_list <- Filter(Negate(is.null), plot_list)  # Remove NULL plots

    combined_plot <- subplot(plot_list, nrows = length(plot_list), shareX = TRUE) %>%
      layout(xaxis = list(rangeslider = list(visible = FALSE), fixedrange = TRUE))

    combined_plot
  })
}

# Run the Shiny app
shinyApp(ui = ui, server = server)
```

## Contact Summary
***

Please use the button below to download the patients entire GP event history as an Excel workbook file.


```{r downloadLogic, echo=FALSE}

library(downloadthis)

# TEMP filter the data for specific patients
Pt_Proc_Wide %>%
  download_this(
    output_name = "Patient_Contact_History",
    output_extension = ".xlsx",
    button_label = "Download patient data",
    button_type = "warning",
    has_icon = TRUE,
    icon = "fa fa-save"
  )
```