---
title: ""
author: ""
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  html_document:
    toc: false
runtime: shiny
---

<style>

body {
    background-color: #fff;
    color: #333;
    font-family: Franklin Gothic;
    font-size: 11pt;
    font-weight: 300;
}

h1, h2, h3, h4 {
  color: #407EC9;
}

hr {
  color: #407EC9;
  border-color: #407EC9;
}

.navbar {
    background-color: #407EC9; 
    border-color: #407EC9; 
    color: #fff; 
}

.btn-primary {
    background-color: #407EC9; 
    border-color: #407EC9;
    color: #fff; 
}

.btn-download {
    background-color: #B2D6E0; 
    border-color: #B2D6E0; 
    color: #fff; 
}

a {
    color: #407EC9; 
}

.toc.float-toc {
    margin-bottom: 20px; 
}

.plot-container {
    max-width: 900px; 
    margin-left: auto; 
    margin-right: 0;
  }
  
.js-plotly-plot .plotly,
.js-plotly-plot .plot-container,
.js-plotly-plot .svg-container {
  overflow: visible !important;
}
  
  .shiny-input-container p em { color: #666; 
}

.plot-outer { overflow: visible !important; 
}

html, body, .container-fluid, .tab-content, .tab-pane {
  height: auto !important;
  min-height: 100vh;
  overflow: visible !important;
}

.plot-outer {
  overflow: visible !important;
}

.info-card{
  background:#f7f9fc;
  border:2px solid #407EC9;
  padding:12px 14px;
  border-radius:10px;
}

.info-card h4{ margin-top:0; 
}

.info-multiline{ white-space:pre-wrap; 
}

.notes-timeline{
  background:#ffffff;
  border:1px solid #e3e8f0;
  border-radius:10px;
  padding:12px 14px;
  max-height:70vh;
  overflow-y:auto;
  padding-right:8px;
}

.month-header{
  position:sticky;
  top:0;
  z-index:5;
  background:#ffffff;
  padding:8px 0 6px 0;
  border-bottom:1px solid #e3e8f0;
  margin-bottom:10px;
  font-weight:700;
  color:#407EC9;
}

.note-card{
  background:#ffffff;
  border:1px solid #e3e8f0;
  border-radius:10px;
  padding:12px 14px;
  margin-bottom:12px;
}

.note-card.pinned{
  background:#f7f9fc;
  border:2px solid #407EC9;
  border-radius:10px;
}

.notes-preview{
  background: #ffffff;
  border: 1px solid #e3e8f0;
  border-radius: 10px;
  overflow: hidden;
}
.notes-preview .note-card{
  border-bottom: none;
  margin: 0;
}

.note-meta{
  font-weight:700;
  color:#407EC9;
  font-size:10.5pt;
  margin-bottom:8px;
}

.note-body{
  white-space:pre-wrap;
  color:#333333;
}
mark{
  background:#fff3b0;
  padding:0 2px;
}

.notes-preview .month-header{
  display: none;
}

</style>

```{css, echo=FALSE}
    body .main-container {
      max-width: 1700px !important;
      width: 1700px !important;
    }
    body {
      max-width: 1700px !important;
    }
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)

source("../config/r_scripts/packages.R")
source("../data_processing/r_scripts/Data_Extraction_Processing.R")

# Loading the processed data

Pt_Proc_Wide <- read_excel(here("data", "processed_extracts", "Proc_Patient_Extract.xlsx"))

# Creating series to call within the patient selection drop down

patient_names <- unique(Pt_Proc_Wide$Patient_Name)

```



```{r examplePlot, fig.height=18, echo=FALSE}

# Function to create time series plots for biomedical and prescription time series

create_time_series_plot <- function(data, date_col, y_col, test_col, unit_col, vis_colour) {
  tryCatch({
    if (!(date_col %in% names(data)) | !(y_col %in% names(data)) | !(test_col %in% names(data)) | !(unit_col %in% names(data))) {
      stop("One or more specified columns are not found in the data frame.")
    }

    data <- data[!is.na(data[[y_col]]), ]

    if (nrow(data) == 0) return(NULL)

    data$tooltip_text <- paste0(
      "Date: ", format(data[[date_col]], "%d/%m/%Y"), "<br>",
      data[[test_col]], ": ", data[[y_col]], " ", data[[unit_col]]
    )

    y_label <- paste(test_col, "<br>(", data[[unit_col]][1], ")", sep = "")

    plot <- ggplot(data, aes(x = !!sym(date_col), y = !!sym(y_col))) +
      geom_line(color = vis_colour) +
      geom_point(aes(text = tooltip_text), color = vis_colour, size = 2) +  
      labs(title = NULL, x = "Date", y = y_label) +
      scale_x_date(date_labels = "%d/%m/%Y", limits = c(as.Date("2020-01-01"), as.Date(Sys.Date()))) +
      theme_minimal() +
      theme(axis.title.y = element_text(size = 12))

    plotly_plot <- ggplotly(plot, tooltip = "text") %>% 
      layout(margin = list(l = 250))

    return(plotly_plot)
  }, error = function(e) {
    return(NULL)
  })
}

# Function to create time series plots for diagnoses time series

create_diagnosis_plot <- function(data, date_col, diagnosis_col, vis_colour) {
  tryCatch({
    if (!(date_col %in% names(data)) | !(diagnosis_col %in% names(data))) {
      stop("One or more specified columns are not found in the data frame.")
    }

    data <- data[!is.na(data[[diagnosis_col]]), ]

    if (nrow(data) == 0) return(NULL)

    data$tooltip_text <- paste0(
      "Date: ", format(data[[date_col]], "%d/%m/%Y"), "<br>",
      "Diagnosis/review: ", data[[diagnosis_col]]
    )

    plot <- ggplot(data, aes(x = !!sym(date_col), y = 1)) + 
      geom_line(color = vis_colour) +
      geom_point(aes(text = tooltip_text), color = vis_colour, size = 2) +  
      labs(title = NULL, x = "Date", y = NULL) +  
      scale_x_date(date_labels = "%d/%m/%Y", limits = c(as.Date("2020-01-01"), as.Date(Sys.Date()))) +
      theme_minimal() +
      theme(
        axis.text.y = element_blank(), 
        axis.ticks.y = element_blank(), 
        axis.title.y = element_blank()
      )

    plotly_plot <- ggplotly(plot, tooltip = "text") %>%
      layout(margin = list(l = 250)) 

    return(plotly_plot)
  }, error = function(e) {
    return(NULL)
  })
}

# UI

ui <- navbarPage(
  title = "Primary Care Timeline Tool",
  id = "main_nav",
  inverse = FALSE,
  header = tags$head(
    tags$style(HTML("
      body {
        width: 100%;
        height: 100%;
        background-color: #fff;
        color: #333;
        font-family: Franklin Gothic, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
        font-size: 11pt;
        font-weight: 300;
      }
      h1, h2, h3, h4 { color: #407EC9; }
      hr { color: #407EC9; border-color: #407EC9; }
      .navbar { background-color: #407EC9; border-color: #407EC9; }
      .navbar .navbar-brand, .navbar .navbar-nav > li > a { color: #fff !important; }
      .btn-primary, .btn-download { background-color: #407EC9; border-color: #407EC9; color: #fff; }
      a { color: #407EC9; }
      .toc.float-toc { margin-bottom: 20px; }
      .plot-container { max-width: 1400px; margin-left: auto; margin-right: 0; }
      .shiny-input-container p em { color: #666; }

      .info-card{
        background:#f7f9fc;
        border:2px solid #407EC9;
        padding:12px 14px;
        border-radius:10px;
      }

      .notes-preview{
        padding:0 !important;
        overflow:hidden;
      }

      
      .notes-timeline{
  background: #ffffff;
  border: 1px solid #e3e8f0;
  border-radius: 10px;
  padding: 0;
  max-height: 70vh;
  overflow-y: auto;
}

.month-header{
  position: sticky;
  top: 0;
  z-index: 5;
  background: #ffffff;
  padding: 10px 14px;
  margin: 0;
  font-weight: 700;
  color: #407EC9;
  border-bottom: 2px solid #407EC9;
}

.note-card{
  padding: 12px 14px;
  margin: 0;
  border-bottom: 1px solid #e3e8f0;  
}

.note-card:last-child{
  border-bottom: none;
}

.note-meta{
  font-weight: 700;
  color: #407EC9;           
  font-size: 11pt;
  margin: 0 0 6px 0;
}

.note-body{
  white-space: pre-wrap;
  color: #333333;
  line-height: 1.35;
  margin: 0;
}

mark{
  background: #fff3b0;
  padding: 0 2px;
  border-radius: 2px;
}

.note-card.pinned{
  background: #f7f9fc;
  border: 2px solid #407EC9;
  border-radius: 10px;
}

.notes-preview .note-card,
.notes-preview .note-card.pinned{
  border: none !important;
  box-shadow: none !important;
}"))),

  tabPanel(
  title = "Timeline Tool",
  fluidPage(

# ROW 1

fluidRow(
  column(
    width = 4,
    h3("Patient selection"),
    p(tags$em("Please select your patient's name from the filter below."), style = "margin-top:-10px; margin-bottom:6px; color:#666; font-size:10pt;"),
    hr(),
    div(
      class = "info-card",
      selectInput("patient_names", "Select Patient name:", choices = patient_names)
    )
  ),
  column(
    width = 4,
    h3("Patient information"),
    p(tags$em("General patient information."), style = "margin-top:-10px; margin-bottom:6px; color:#666; font-size:10pt;"),
    hr(),
    uiOutput("patient_report", container = div, class = "info-card")
  ),
  column(
    width = 4,
    h3("Clinical notes"),
    p(tags$em("Most recently available note: see 'Clinical Notes' tab for further information."), style = "margin-top:-10px; margin-bottom:6px; color:#666; font-size:10pt;"),
    hr(),
    div(class = "info-card notes-preview", uiOutput("clinical_free_text"))
  )
),

# ROW 2 (filters)

fluidRow(
  column(
    width = 4,
    h3("Diagnoses"),
    p(tags$em("Date included is of initial diagnosis."), style = "margin-top:-10px; margin-bottom:6px; color:#666; font-size:10pt;"),
    hr(),
    uiOutput("dx_filter_ui", container = div, class = "info-card")
  ),
  column(
    width = 4,
    h3("Biomedical tests"),
    p(tags$em("Date included is of latest test."), style = "margin-top:-10px; margin-bottom:6px; color:#666; font-size:10pt;"),
    hr(),
    uiOutput("lab_filter_ui", container = div, class = "info-card")
  ),
  column(
    width = 4,
    h3("Prescriptions"),
    p(tags$em("Date included is of initial prescription."), style = "margin-top:-10px; margin-bottom:6px; color:#666; font-size:10pt;"),
    hr(),
    uiOutput("drug_filter_ui", container = div, class = "info-card")
  )
),

# ROW 3

    fluidRow(
      column(
        width = 12,
        h3("Primary care timeline tool"),
        hr(),
        p("The time series below visualises the patient's GP contact history, displaying diagnoses, prescriptions, and assay results."),
        div(class = "plot-outer", uiOutput("combined_plot_ui")),
        br(),
        actionButton(
          "toggle_summary_tables",
          "Show / hide summary tables",
          class = "btn btn-default btn-sm"
        ),
        br(), br(),
        uiOutput("summary_tables_ui")
      )
    ),

    fluidRow(
      column(
        width = 3,
        h3("Contact summary"),
        hr(),
        p("Please use the button below to download the patient's entire GP event history as an Excel workbook file."),
        downloadButton("downloadData", label = "Download patient data", class = "btn-download")
      ),
      column(width = 9)
    )
  )
),

    # Clinical Notes
  tabPanel(
    title = "Clinical Notes",
    fluidPage(
      br(),
      h2("Clinical free text timeline"),
      hr(),
      fluidRow(
        column(
          width = 6,
          textInput(
            "notes_search",
            label = "Search clinical notes",
            placeholder = "e.g. dizziness, BP, metformin, HbA1c..."
          )
        ),
        column(
          width = 6,
          checkboxInput("notes_show_all", "Show all notes (ignore search filter)", value = FALSE)
        )
      ),
      br(),
      div(
        class = "notes-timeline",
        uiOutput("clinical_notes_timeline")
      )
    )
  )
,
  # User Guidance
  tabPanel(
      title = "User Guidance",
      fluidPage(
        br(),
        h2("User guidance"),
        hr(),
        p("Space for any appropriate introductory text to be included by University of Liverpool / Data Into Action."),

        br(),
        h2("Categories explored within this tool"),
        hr(),
        p("Following the selection of one of the (fictional) patient's names, the time series below visualises the patient's GP contact history, displaying the following information:"),
        tags$ul(
          tags$li("Date of contact;"),
          tags$li("The initial date of any relevant diagnoses;"),
          tags$li("Any prescriptions (or changes to existing prescriptions) made on date of contact; and"),
          tags$li("The results of any relevant biomedical assays completed on date of contact.")
        )
      )
    )
)


# Server



# Helper: build dynamic y-axis labels for plots (diagnoses/tests vs drugs)
create_dynamic_label <- function(data, test_col = NULL, unit_col = NULL, drug_col = NULL, drug_unit_col = NULL, is_test = TRUE) {
    if (is_test) {
      first_non_na_test <- data[[test_col]][!is.na(data[[test_col]])][1]
      first_non_na_unit <- if (!is.null(unit_col) && unit_col != "" && unit_col %in% names(data)) data[[unit_col]][!is.na(data[[unit_col]])][1] else NA
      if (!is.na(first_non_na_test)) {
        if (!is.null(first_non_na_unit) && !is.na(first_non_na_unit)) return(paste(first_non_na_test, "<br>", first_non_na_unit))
        return(first_non_na_test)
      }
    } else {
      first_non_na_drug <- data[[drug_col]][!is.na(data[[drug_col]])][1]
      first_non_na_drug_unit <- data[[drug_unit_col]][!is.na(data[[drug_unit_col]])][1]
      if (!is.na(first_non_na_drug)) {
        if (!is.null(first_non_na_drug_unit) && !is.na(first_non_na_drug_unit)) return(paste(first_non_na_drug, "<br>", first_non_na_drug_unit))
        return(first_non_na_drug)
      }
    }
    return("Unknown Value")
  }

server <- function(input, output, session) {

  checkboxGroupHTML <- function(inputId, label, choiceValues, choiceLabels, selected = choiceValues) {
    tags$div(
      class = "form-group shiny-input-container",
      tags$label(class = "control-label", `for` = inputId, label),
      tags$div(
        id = inputId,
        class = "shiny-input-checkboxgroup shiny-bound-input",
        lapply(seq_along(choiceValues), function(i) {
          val <- choiceValues[[i]]
          lab <- choiceLabels[[i]]
          tags$div(
            class = "checkbox",
            tags$label(
              tags$input(
                type = "checkbox",
                name = inputId,
                value = val,
                checked = if (val %in% selected) "checked" else NULL
              ),
              tags$span(lab)
            )
          )
        })
      )
    )
  }


# Reactive expression to filter data by selected patient
  
  Pt_Wide_reactive <- reactive({
    req(input$patient_names)
    Pt_Proc_Wide %>%
      filter(Patient_Name == input$patient_names) %>%
      mutate(Contact_Event_Date = suppressWarnings(as.Date(gsub("/", "-", as.character(Contact_Event_Date)), format = "%Y-%m-%d")))
})
  

  # Summary tables
  
  dx_table_data <- reactive({
    d <- Pt_Wide_reactive()
    if (is.null(d) || nrow(d) == 0) return(data.frame())

    dx <- d %>%
      dplyr::select(Contact_Event_Date, dplyr::starts_with("Diagnosis_")) %>%
      tidyr::pivot_longer(
        cols = dplyr::starts_with("Diagnosis_"),
        names_to = "Diagnosis_Field",
        values_to = "Diagnosis"
      ) %>%
      dplyr::filter(!is.na(Diagnosis), Diagnosis != "") %>%
      dplyr::mutate(Contact_Event_Date = as.Date(Contact_Event_Date)) %>%
      dplyr::distinct(Contact_Event_Date, Diagnosis) %>%
      dplyr::arrange(Contact_Event_Date)

    if (!is.null(input$dx_filter)) {
      if (length(input$dx_filter) == 0) {
        dx <- dx[0, , drop = FALSE]
      } else {
        dx <- dx %>% dplyr::filter(Diagnosis %in% input$dx_filter)
      }
    }

    dx
  })

  rx_table_data <- reactive({
    req(input$patient_names)

    d <- Pt_Proc_Wide %>%
      filter(Patient_Name == input$patient_names)

    rx1 <- d %>%
      transmute(
        Contact_Event_Date = as.Date(Contact_Event_Date),
        Drug = Drug_Name_1,
        Dose = Drug_1_Value,
        Units = Drug_1_Units
      )

    rx2 <- d %>%
      transmute(
        Contact_Event_Date = as.Date(Contact_Event_Date),
        Drug = Drug_Name_2,
        Dose = Drug_2_Value,
        Units = Drug_2_Units
      )

    out <- bind_rows(rx1, rx2) %>%
      filter(!is.na(Drug) & Drug != "") %>%
      distinct() %>%
      arrange(Contact_Event_Date)

    if (!is.null(input$drug_filter)) {
      if (length(input$drug_filter) == 0) {
        out <- out[0, , drop = FALSE]
      } else {
        out <- out %>% filter(Drug %in% input$drug_filter)
      }
    }

    out
  })

  lab_table_data <- reactive({
    req(input$patient_names)

    d <- Pt_Proc_Wide %>%
      filter(Patient_Name == input$patient_names)

    lab1 <- d %>%
      transmute(
        Contact_Event_Date = as.Date(Contact_Event_Date),
        Test = Biomedical_Test_1,
        Value = Biomedical_Value_1,
        Units = Biomedical_1_Units
      )

    lab2 <- d %>%
      transmute(
        Contact_Event_Date = as.Date(Contact_Event_Date),
        Test = Biomedical_Test_2,
        Value = Biomedical_Value_2,
        Units = Biomedical_2_Units
      )

    out <- bind_rows(lab1, lab2) %>%
      filter(!is.na(Test) & Test != "") %>%
      distinct() %>%
      arrange(Contact_Event_Date)

    if (!is.null(input$lab_filter)) {
      if (length(input$lab_filter) == 0) {
        out <- out[0, , drop = FALSE]
      } else {
        out <- out %>% filter(Test %in% input$lab_filter)
      }
    }

    out
  })

  output$tbl_dx <- DT::renderDataTable({
    DT::datatable(
      dx_table_data(),
      rownames = FALSE,
      options = list(pageLength = 6, lengthChange = FALSE)
    )
  })

  output$tbl_lab <- DT::renderDataTable({
    DT::datatable(
      lab_table_data(),
      rownames = FALSE,
      options = list(pageLength = 6, lengthChange = FALSE)
    )
  })

  output$tbl_rx <- DT::renderDataTable({
    DT::datatable(
      rx_table_data(),
      rownames = FALSE,
      options = list(pageLength = 6, lengthChange = FALSE)
    )
  })

  show_summary_tables <- reactiveVal(FALSE)

  observeEvent(input$toggle_summary_tables, {
    show_summary_tables(!show_summary_tables())
  })

  output$summary_tables_ui <- renderUI({
    if (!show_summary_tables()) return(NULL)

    div(
      class = "info-card",
      h3("Summary tables"),
      p("Tabular view of the data shown in the time series plots."),
      hr(),
      h4("Diagnoses"),
      DT::dataTableOutput("tbl_dx"),
      br(),
      h4("Biomedical tests"),
      DT::dataTableOutput("tbl_lab"),
      br(),
      h4("Prescriptions"),
      DT::dataTableOutput("tbl_rx")
    )
  })

  output$clinical_free_text <- renderUI({
  d <- Pt_Wide_reactive()
  nm <- if (nrow(d)) trimws(d$Patient_Name[1]) else "Selected patient"

  notes <- make_fake_notes(nm)
  notes <- notes[order(notes$note_date, decreasing = TRUE), , drop = FALSE]

  if (nrow(notes) == 0) {
    return(tags$div(
      class = "note-card pinned",
      tags$div(class = "note-meta", "No notes available."),
      tags$div(class = "note-body", "No clinical free-text entries were found for this patient.")
    ))
  }
  meta_line <- paste0(
    format(notes$note_date[1], "%d %b %Y"),
    " • ",
    notes$note_type[1],
    " • ",
    nm
  )

  tags$div(
      class = "note-card pinned",
      tags$div(class = "note-meta", meta_line),
      tags$div(class = "note-body", notes$note_body[1])
    )
  
})

# Clinical Notes tab

highlight_term <- function(text, term) {
  if (is.null(term) || !nzchar(trimws(term))) return(htmltools::htmlEscape(text))
  term <- trimws(term)

  safe <- htmltools::htmlEscape(text)

  patt <- gsub("([\\^\\$\\.|\\?\\*\\+\\(\\)\\[\\]\\{\\}\\\\])", "\\\\\\1", term)

  gsub(paste0("(?i)(", patt, ")"), "<mark>\\1</mark>", safe, perl = TRUE)
}

# Placeholders

make_fake_notes <- function(patient_name) {
  seed_val <- sum(utf8ToInt(patient_name)) %% 10000
  set.seed(seed_val)

  n_notes <- 18
  dates <- sort(sample(seq.Date(Sys.Date() - 365, Sys.Date(), by = "day"), n_notes), decreasing = TRUE)

  types <- sample(
    c("Telephone consultation", "Face-to-face review", "Results review", "Medication review"),
    n_notes, replace = TRUE
  )

  templates <- c(
    "Pt reports intermittent fatigue. No red flags.\nDiscussed hydration and sleep hygiene.\nSafety-netting given.",
    "Vitals reviewed. No acute distress.\nMedication reconciliation completed.\nPlan: routine bloods and follow-up.",
    "Discussed recent results.\nAgreed lifestyle measures.\nPlan: repeat labs in 3 months.",
    "Adherence good. No adverse effects reported.\nPlan: continue current regimen and monitor."
  )

  bodies <- vapply(seq_len(n_notes), function(i) {
    paste0(
      templates[sample.int(length(templates), 1)],
      "\n\nProblem list (fictional):\n- Hypertension\n- Type 2 diabetes mellitus\n- Hyperlipidaemia"
    )
  }, character(1))

  data.frame(
    note_date = dates,
    note_type = types,
    note_body = bodies,
    stringsAsFactors = FALSE
  )
}

# Render timeline UI
output$clinical_notes_timeline <- renderUI({
  d <- Pt_Wide_reactive()
  nm <- if (nrow(d)) trimws(d$Patient_Name[1]) else "Selected patient"

  notes <- make_fake_notes(nm)
  notes <- notes[order(notes$note_date, decreasing = TRUE), , drop = FALSE]

  q <- input$notes_search
  show_all <- isTRUE(input$notes_show_all)

  if (!show_all && !is.null(q) && nzchar(trimws(q))) {
    q2 <- tolower(trimws(q))
    keep <- grepl(q2, tolower(notes$note_body)) | grepl(q2, tolower(notes$note_type))
    notes <- notes[keep, , drop = FALSE]
  }

  if (nrow(notes) == 0) {
    return(tags$div(
      class = "note-card",
      tags$div(class = "note-meta", "No matching notes."),
      tags$div(class = "note-body", "Try a different search term, or tick 'Show all notes'.")
    ))
  }

  notes$month_key <- format(notes$note_date, "%B %Y")
  month_levels <- unique(notes$month_key)

  out <- list()

  for (m in month_levels) {
    out <- c(out, list(tags$div(class = "month-header", m)))

    idx <- which(notes$month_key == m)

    for (i in idx) {
      is_latest <- (i == 1) 

      meta_line <- paste0(
        format(notes$note_date[i], "%d %b %Y"),
        " • ",
        notes$note_type[i],
        " • ",
        nm
      )

      body_html <- highlight_term(notes$note_body[i], q)

      out <- c(out, list(
        tags$div(
          class = paste("note-card", if (is_latest) "pinned" else ""),
          tags$div(class = "note-meta", meta_line),
          tags$div(class = "note-body", HTML(body_html))
        )
      ))
    }
  }

  do.call(tagList, out)
})
  
# Updating the available Visualisation list based on selected patient
  
# Populating the three multi-selects when a patient is chosen

dx_choices <- reactive({
  d <- Pt_Wide_reactive()
  ch <- sort(unique(c(d$Diagnosis_1, d$Diagnosis_2)))
  ch[!is.na(ch) & ch != ""]
})

lab_choices <- reactive({
  d <- Pt_Wide_reactive()
  ch <- sort(unique(c(d$Biomedical_Test_1, d$Biomedical_Test_2)))
  ch[!is.na(ch) & ch != ""]
})

drug_choices <- reactive({
  d <- Pt_Wide_reactive()
  ch <- sort(unique(c(d$Drug_Name_1, d$Drug_Name_2)))
  ch[!is.na(ch) & ch != ""]
})

# Rendering the three filter UIs

output$dx_filter_ui <- renderUI({
  d <- Pt_Wide_reactive()

  if (nrow(d) == 0) {
    return(div(
      h4("Diagnoses"),
      hr(),
      checkboxGroupInput("dx_filter", label = NULL, choices = character(0), selected = character(0))
    ))
  }

  dx_long <- d %>%
    dplyr::select(Contact_Event_Date, Diagnosis_1, Diagnosis_2) %>%
    tidyr::pivot_longer(
      cols = dplyr::starts_with("Diagnosis_"),
      names_to = "src",
      values_to = "Diagnosis"
    ) %>%
    dplyr::filter(!is.na(Diagnosis), Diagnosis != "") %>%
    dplyr::mutate(Contact_Event_Date = suppressWarnings(as.Date(Contact_Event_Date))) %>%
    dplyr::group_by(Diagnosis) %>%
    dplyr::summarise(first_date = min(Contact_Event_Date, na.rm = TRUE), .groups = "drop") %>%
    dplyr::arrange(Diagnosis)

  ch <- dx_long$Diagnosis
  dates <- dx_long$first_date

  choice_names <- lapply(seq_along(ch), function(i) {
    dt <- dates[[i]]
    dt_txt <- if (!is.na(dt)) format(dt, "%d %b %Y") else ""
    htmltools::HTML(paste0(htmltools::htmlEscape(ch[[i]]), "&nbsp;&nbsp;<em>", dt_txt, "</em>"))
  })

  div(
    h4("Diagnoses"),
    hr(),
    checkboxGroupInput(
      inputId      = "dx_filter",
      label        = NULL,
      choiceNames  = choice_names,
      choiceValues = ch,
      selected     = ch
    )
  )
})

output$lab_filter_ui <- renderUI({
  d <- Pt_Wide_reactive()

  if (nrow(d) == 0) {
    return(div(
      h4("Biomedical tests"),
      hr(),
      checkboxGroupInput("lab_filter", label = NULL, choices = character(0), selected = character(0))
    ))
  }

  lab_long <- d %>%
    dplyr::select(Contact_Event_Date, Biomedical_Test_1, Biomedical_Test_2) %>%
    tidyr::pivot_longer(
      cols = c(Biomedical_Test_1, Biomedical_Test_2),
      names_to = "Test_Number",
      values_to = "Test"
    ) %>%
    dplyr::filter(!is.na(Test), Test != "") %>%
    dplyr::mutate(Contact_Event_Date = suppressWarnings(as.Date(Contact_Event_Date))) %>%
    dplyr::group_by(Test) %>%
    dplyr::summarise(
      date_of_latest = if (all(is.na(Contact_Event_Date))) as.Date(NA) else max(Contact_Event_Date, na.rm = TRUE),
      .groups = "drop"
    ) %>%
    dplyr::arrange(Test)

  ch <- lab_long$Test
  dates <- lab_long$date_of_latest

  choice_names <- lapply(seq_along(ch), function(i) {
    dt <- dates[[i]]
    dt_txt <- if (!is.na(dt)) format(dt, "%d %b %Y") else ""
    htmltools::HTML(paste0(htmltools::htmlEscape(ch[[i]]), "&nbsp;&nbsp;<em>", dt_txt, "</em>"))
  })

  div(
    h4("Biomedical tests"),
    hr(),
    checkboxGroupInput(
      inputId      = "lab_filter",
      label        = NULL,
      choiceNames  = choice_names,
      choiceValues = ch,
      selected     = ch
    )
  )
})

output$drug_filter_ui <- renderUI({
  d <- Pt_Wide_reactive()

  if (nrow(d) == 0) {
    return(div(
      h4("Drugs"),
      hr(),
      checkboxGroupInput("drug_filter", label = NULL, choices = character(0), selected = character(0))
    ))
  }

  rx_long <- dplyr::bind_rows(
    tibble::tibble(Contact_Event_Date = d$Contact_Event_Date, Drug = d$Drug_Name_1),
    tibble::tibble(Contact_Event_Date = d$Contact_Event_Date, Drug = d$Drug_Name_2)
  ) %>%
    dplyr::filter(!is.na(Drug), Drug != "") %>%
    dplyr::mutate(Contact_Event_Date = suppressWarnings(as.Date(Contact_Event_Date))) %>%
    dplyr::group_by(Drug) %>%
    dplyr::summarise(first_date = min(Contact_Event_Date, na.rm = TRUE), .groups = "drop") %>%
    dplyr::arrange(Drug)

  ch <- rx_long$Drug
  dates <- rx_long$first_date

  choice_names <- lapply(seq_along(ch), function(i) {
    dt <- dates[[i]]
    dt_txt <- if (!is.na(dt)) format(dt, "%d %b %Y") else ""
    htmltools::HTML(paste0(htmltools::htmlEscape(ch[[i]]), "&nbsp;&nbsp;<em>", dt_txt, "</em>"))
  })

  div(
    h4("Drugs"),
    hr(),
    checkboxGroupInput(
      inputId      = "drug_filter",
      label        = NULL,
      choiceNames  = choice_names,
      choiceValues = ch,
      selected     = ch
    )
  )
})

# Reset filters when the patient changes (Shiny otherwise preserves previous selections,
  # which can leave everything unchecked when the choice lists change).
  observeEvent(Pt_Wide_reactive(), {
    d <- Pt_Wide_reactive()

    # Diagnoses (first recorded date)
    dx_choices <- d %>%
      dplyr::select(Contact_Event_Date, Diagnosis_1, Diagnosis_2) %>%
      tidyr::pivot_longer(cols = c(Diagnosis_1, Diagnosis_2), values_to = "Diagnosis") %>%
      dplyr::filter(!is.na(Diagnosis), Diagnosis != "") %>%
      dplyr::mutate(Contact_Event_Date = suppressWarnings(as.Date(Contact_Event_Date))) %>%
      dplyr::group_by(Diagnosis) %>%
      dplyr::summarise(
        date_of_first = if (all(is.na(Contact_Event_Date))) as.Date(NA) else min(Contact_Event_Date, na.rm = TRUE),
        .groups = "drop"
      ) %>%
      dplyr::arrange(Diagnosis)

    shiny::updateCheckboxGroupInput(
      session,
      "dx_filter",
      selected = if (nrow(dx_choices) > 0) dx_choices$Diagnosis else character(0)
    )

    # Biomedical tests (latest recorded date)
    lab_choices <- d %>%
      dplyr::select(Contact_Event_Date, Biomedical_Test_1, Biomedical_Test_2) %>%
      tidyr::pivot_longer(cols = c(Biomedical_Test_1, Biomedical_Test_2), values_to = "Test") %>%
      dplyr::filter(!is.na(Test), Test != "") %>%
      dplyr::mutate(Contact_Event_Date = suppressWarnings(as.Date(Contact_Event_Date))) %>%
      dplyr::group_by(Test) %>%
      dplyr::summarise(
        date_of_latest = if (all(is.na(Contact_Event_Date))) as.Date(NA) else max(Contact_Event_Date, na.rm = TRUE),
        .groups = "drop"
      ) %>%
      dplyr::arrange(Test)

    shiny::updateCheckboxGroupInput(
      session,
      "lab_filter",
      selected = if (nrow(lab_choices) > 0) lab_choices$Test else character(0)
    )

    # Prescriptions (first recorded date)
    rx_choices <- d %>%
      dplyr::select(Contact_Event_Date, Drug_Name_1, Drug_Name_2) %>%
      tidyr::pivot_longer(cols = c(Drug_Name_1, Drug_Name_2), values_to = "Drug") %>%
      dplyr::filter(!is.na(Drug), Drug != "") %>%
      dplyr::mutate(Contact_Event_Date = suppressWarnings(as.Date(Contact_Event_Date))) %>%
      dplyr::group_by(Drug) %>%
      dplyr::summarise(
        date_of_first = if (all(is.na(Contact_Event_Date))) as.Date(NA) else min(Contact_Event_Date, na.rm = TRUE),
        .groups = "drop"
      ) %>%
      dplyr::arrange(Drug)

    shiny::updateCheckboxGroupInput(
      session,
      "drug_filter",
      selected = if (nrow(rx_choices) > 0) rx_choices$Drug else character(0)
    )
  }, ignoreInit = FALSE)

combined_height <- reactive({
  d <- Pt_Wide_reactive()
  if (nrow(d) == 0) return(300)

  sel_dx   <- if (is.null(input$dx_filter))   character(0) else input$dx_filter
  sel_lab  <- if (is.null(input$lab_filter))  character(0) else input$lab_filter
  sel_drug <- if (is.null(input$drug_filter)) character(0) else input$drug_filter

  dx1_d <- if (length(sel_dx) > 0)   d %>% dplyr::filter(Diagnosis_1 %in% sel_dx) else d[0, , drop = FALSE]
  dx2_d <- if (length(sel_dx) > 0)   d %>% dplyr::filter(Diagnosis_2 %in% sel_dx) else d[0, , drop = FALSE]
  l1_d  <- if (length(sel_lab) > 0)  d %>% dplyr::filter(Biomedical_Test_1 %in% sel_lab) else d[0, , drop = FALSE]
  l2_d  <- if (length(sel_lab) > 0)  d %>% dplyr::filter(Biomedical_Test_2 %in% sel_lab) else d[0, , drop = FALSE]
  r1_d  <- if (length(sel_drug) > 0) d %>% dplyr::filter(Drug_Name_1 %in% sel_drug) else d[0, , drop = FALSE]
  r2_d  <- if (length(sel_drug) > 0) d %>% dplyr::filter(Drug_Name_2 %in% sel_drug) else d[0, , drop = FALSE]

  plots <- list(
    create_diagnosis_plot(dx1_d, "Contact_Event_Date", "Diagnosis_1", "#fa5c5c"),
    create_diagnosis_plot(dx2_d, "Contact_Event_Date", "Diagnosis_2", "#36a358"),
    create_time_series_plot(l1_d, "Contact_Event_Date", "Biomedical_Value_1", "Biomedical_Test_1", "Biomedical_1_Units", "#407EC9"),
    create_time_series_plot(l2_d, "Contact_Event_Date", "Biomedical_Value_2", "Biomedical_Test_2", "Biomedical_2_Units", "#407EC9"),
    create_time_series_plot(r1_d, "Contact_Event_Date", "Drug_1_Value", "Drug_Name_1", "Drug_1_Units", "#ff9933"),
    create_time_series_plot(r2_d, "Contact_Event_Date", "Drug_2_Value", "Drug_Name_2", "Drug_2_Units", "#ff9933")
  )

  n_panels <- length(Filter(Negate(is.null), plots))
  if (n_panels == 0) return(300)

  per_panel_height <- 180
  base_margin_px   <- 100
  max(200, n_panels * per_panel_height + base_margin_px)
})

output$combined_plot_ui <- renderUI({
  plotlyOutput("combined_plot", height = paste0(combined_height(), "px"), width = "100%")
})

# Rendering the combined plot based on selected visualisation
  
output$combined_plot <- renderPlotly({
  d <- Pt_Wide_reactive()
  if (nrow(d) == 0) {
    showNotification("No data available for the selected patient.", type = "warning")
    return(NULL)
  }

  sel_dx   <- if (is.null(input$dx_filter))   character(0) else input$dx_filter
  sel_lab  <- if (is.null(input$lab_filter))  character(0) else input$lab_filter
  sel_drug <- if (is.null(input$drug_filter)) character(0) else input$drug_filter

  # Filter per panel (NOT across categories). This is the key fix:
  # unticking a diagnosis should only affect diagnosis panels; labs/drugs shouldn't "keep rows alive".
  dx1_d <- if (length(sel_dx) > 0)   d %>% dplyr::filter(Diagnosis_1 %in% sel_dx) else d[0, , drop = FALSE]
  dx2_d <- if (length(sel_dx) > 0)   d %>% dplyr::filter(Diagnosis_2 %in% sel_dx) else d[0, , drop = FALSE]
  l1_d  <- if (length(sel_lab) > 0)  d %>% dplyr::filter(Biomedical_Test_1 %in% sel_lab) else d[0, , drop = FALSE]
  l2_d  <- if (length(sel_lab) > 0)  d %>% dplyr::filter(Biomedical_Test_2 %in% sel_lab) else d[0, , drop = FALSE]
  r1_d  <- if (length(sel_drug) > 0) d %>% dplyr::filter(Drug_Name_1 %in% sel_drug) else d[0, , drop = FALSE]
  r2_d  <- if (length(sel_drug) > 0) d %>% dplyr::filter(Drug_Name_2 %in% sel_drug) else d[0, , drop = FALSE]

  plot_list <- list(
    create_diagnosis_plot(dx1_d, "Contact_Event_Date", "Diagnosis_1", "#fa5c5c"),
    create_diagnosis_plot(dx2_d, "Contact_Event_Date", "Diagnosis_2", "#36a358"),
    create_time_series_plot(l1_d, "Contact_Event_Date", "Biomedical_Value_1", "Biomedical_Test_1", "Biomedical_1_Units", "#407EC9"),
    create_time_series_plot(l2_d, "Contact_Event_Date", "Biomedical_Value_2", "Biomedical_Test_2", "Biomedical_2_Units", "#407EC9"),
    create_time_series_plot(r1_d, "Contact_Event_Date", "Drug_1_Value", "Drug_Name_1", "Drug_1_Units", "#ff9933"),
    create_time_series_plot(r2_d, "Contact_Event_Date", "Drug_2_Value", "Drug_Name_2", "Drug_2_Units", "#ff9933")
  )

  label_list <- list(
    if (!is.null(plot_list[[1]])) create_dynamic_label(dx1_d, test_col = "Diagnosis_1", unit_col = "", is_test = TRUE) else NULL,
    if (!is.null(plot_list[[2]])) create_dynamic_label(dx2_d, test_col = "Diagnosis_2", unit_col = "", is_test = TRUE) else NULL,
    if (!is.null(plot_list[[3]])) create_dynamic_label(l1_d,  test_col = "Biomedical_Test_1", unit_col = "Biomedical_1_Units", is_test = TRUE) else NULL,
    if (!is.null(plot_list[[4]])) create_dynamic_label(l2_d,  test_col = "Biomedical_Test_2", unit_col = "Biomedical_2_Units", is_test = TRUE) else NULL,
    if (!is.null(plot_list[[5]])) create_dynamic_label(r1_d,  drug_col = "Drug_Name_1", drug_unit_col = "Drug_1_Units", is_test = FALSE) else NULL,
    if (!is.null(plot_list[[6]])) create_dynamic_label(r2_d,  drug_col = "Drug_Name_2", drug_unit_col = "Drug_2_Units", is_test = FALSE) else NULL
  )

  valid_idx    <- which(!sapply(plot_list, is.null))
  valid_plots  <- plot_list[valid_idx]
  valid_labels <- label_list[valid_idx]

  if (length(valid_plots) == 0) {
    showNotification("No valid plots for the current filters.", type = "warning")
    return(NULL)
  }

  n_panels <- length(valid_plots)

  combined_plot <- plotly::subplot(
    valid_plots,
    nrows  = n_panels,
    shareX = TRUE,
    titleX = TRUE
  ) %>%
    layout(
      annotations = lapply(seq_along(valid_labels), function(i) {
        list(
          x = -0.10,
          y = 1 - (i - 1) * (1 / n_panels) - 0.11,
          text = valid_labels[[i]],
          showarrow = FALSE,
          xref = "paper",
          yref = "paper",
          xanchor = "center",
          yanchor = "middle",
          textangle = 0,
          font = list(size = 14)
        )
      }),
      height = combined_height()
    )

  combined_plot
})

# Creating the patient report output
  
output$patient_report <- renderUI({
  req(Pt_Wide_reactive())

  # Use the currently selected patient's record
  filtered_data <- Pt_Wide_reactive()
  req(nrow(filtered_data) > 0)

  patient_name <- filtered_data$Patient_Name[1]
  patient_sex  <- filtered_data$Patient_Gender[1]

  # DOB parsing
  
  dob_raw <- filtered_data$Patient_DOB[1]
  if (inherits(dob_raw, "Date")) {
    patient_dob <- dob_raw
  } else {
    patient_dob <- suppressWarnings(lubridate::parse_date_time(
      as.character(dob_raw),
      orders = c("Y-m-d", "Y/m/d", "d/m/Y", "d-m-Y", "Y-m-d H:M:S", "d/m/Y H:M:S"),
      tz = "UTC"
    ))
    patient_dob <- as.Date(patient_dob)
  }

  # Age
  
  patient_age <- NA_integer_
  if (!is.na(patient_dob)) {
    patient_age <- floor(lubridate::time_length(lubridate::interval(patient_dob, Sys.Date()), "years"))
  }

  # Fictional placeholder metrics
  
  old_seed <- if (exists(".Random.seed", envir = .GlobalEnv)) .Random.seed else NULL
  on.exit({ if (!is.null(old_seed)) .Random.seed <<- old_seed }, add = TRUE)

  seed <- sum(utf8ToInt(as.character(patient_name)))
  set.seed(seed)
  height_m <- round(runif(1, 1.50, 1.90), 2)
  weight_kg <- round(runif(1, 55, 110), 0)
  bmi <- round(weight_kg / (height_m^2), 1)
  allergy_options <- c("None known", "Penicillin (rash)", "Peanuts (anaphylaxis)", "Ibuprofen (wheeze)", "Latex (contact dermatitis)")
  allergies <- sample(allergy_options, 1)

  tagList(
    tags$p(
      tags$strong("Patient Name: "), patient_name, tags$br(),
      tags$strong("Sex: "), patient_sex, tags$br(),
      tags$strong("Date of Birth: "), ifelse(is.na(patient_dob), "Unknown", format(patient_dob, "%d/%m/%Y")), tags$br(),
      tags$strong("Age: "), ifelse(is.na(patient_age), "Unknown", paste0(patient_age, " years")), tags$br(),
      tags$strong("Height: "), paste0(height_m, " m"), tags$br(),
      tags$strong("Weight: "), paste0(weight_kg, " kg"), tags$br(),
      tags$strong("BMI: "), bmi, tags$br(),
      tags$strong("Allergies: "), allergies
    )
  )
})


# Creating the patient dataset download

output$downloadData <- downloadHandler(
  filename = function() {
    paste("Theograph_Patient_Summary_", Sys.Date(), ".xlsx", sep = "")
  },
  content = function(file) {
    filtered_data <- Pt_Wide_reactive()
    write.xlsx(filtered_data, file)  
  }
)

}

shinyApp(ui = ui, server = server, options = list(height = 2200))

```